---
title: "GSD and GP regression - week 6"
output: 
  html_document:
    toc: true
    toc_depth: 4
    toc_float: 
      collapsed: false
date: "2025-11-13"
---

```{css, echo=FALSE}
#TOC {
    max-width: fit-content;
    white-space: nowrap;
}
  
div:has(> #TOC) {
    display: flex;
    flex-direction: row-reverse;
}
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# load required libraries
library(mvtnorm)
library(ggplot2)

# set the seed
set.seed(585883357)
```

# GSD simulations

1. Design a trial, including boundaries
2. Obtain the characteristics of this trial
3. Estimate the expected sample size
4. Modify the sample size to obtain the correct power

The functions needed for the above steps are:

1. `triangular_bounds()`
2. `pocock_bounds()`
3. `of_bounds()`
4. `gsd_simulations()`

# Load the personal package

```{r}
devtools::load_all(path = "../groupSequentialDesigns/")
```


# Calculate ESS, VSS, and power

Calculate the boundaries.

```{r}
pocock_bounds <- calc_bounds_pocock()
of_bounds <- calc_bounds_of()
tri_bounds <- calc_bounds_triangular()
```

Get values for ESS, VSS, and power.

First, generate $\delta$ vector.

```{r}
deltas <- seq(from = 0, to = 1, by = 0.001)
```

## Adjust the power

Changing the sample size will adjust the power.

### Pocock

```{r}
gsd_simulations(upper_bounds = pocock_bounds$upper_bounds,
                lower_bounds = pocock_bounds$lower_bounds,
                n_patients = c(19.51241 * 1:3))[c("alpha", "power")]
```


```{r}
gsd_simulations(upper_bounds = pocock_bounds$upper_bounds,
                lower_bounds = pocock_bounds$lower_bounds,
                n_patients = c(10 * 1:3))[c("alpha", "power")]
```

### O'Brien-Fleming

```{r}
gsd_simulations(upper_bounds = of_bounds$upper_bounds,
                lower_bounds = of_bounds$lower_bounds,
                n_patients = c(16.93269 * 1:3))[c("alpha", "power")]
```

```{r}
gsd_simulations(upper_bounds = of_bounds$upper_bounds,
                lower_bounds = of_bounds$lower_bounds,
                n_patients = c(10 * 1:3))[c("alpha", "power")]
```

### Triangular

```{r}
gsd_simulations(upper_bounds = tri_bounds$upper_bounds,
                lower_bounds = tri_bounds$lower_bounds,
                n_patients = c(20.43845 * 1:3))[c("alpha", "power")]
```


```{r}
gsd_simulations(upper_bounds = tri_bounds$upper_bounds,
                lower_bounds = tri_bounds$lower_bounds,
                n_patients = c(10 * 1:3))[c("alpha", "power")]
```

## Plots

### Pocock

```{r}
pk_power <- vector(mode = "numeric", length = length(deltas))
pk_ess <- vector(mode = "numeric", length = length(deltas))
pk_vss <- vector(mode = "numeric", length = length(deltas))

for (i in 1:length(deltas)) {
  
  sim <- gsd_simulations(upper_bounds = pocock_bounds$upper_bounds,
                         lower_bounds = pocock_bounds$lower_bounds,
                         alt_hypothesis = deltas[i],
                         n_patients = c(19.51241 * 1:3))
  
  pk_power[i] <- sim$power
  pk_ess[i] <- sim$expected_sample_size
  pk_vss[i] <- sim$var_sample_size
}
```

### O'Brien-Fleming

```{r}
of_power <- vector(mode = "numeric", length = length(deltas))
of_ess <- vector(mode = "numeric", length = length(deltas))
of_vss <- vector(mode = "numeric", length = length(deltas))

for (i in 1:length(deltas)) {
  
  sim <- gsd_simulations(upper_bounds = of_bounds$upper_bounds,
                         lower_bounds = of_bounds$lower_bounds,
                         alt_hypothesis = deltas[i],
                         n_patients = c(16.93269 * 1:3))
  
  of_power[i] <- sim$power
  of_ess[i] <- sim$expected_sample_size
  of_vss[i] <- sim$var_sample_size
}
```

### Triangular

```{r}
tr_power <- vector(mode = "numeric", length = length(deltas))
tr_ess <- vector(mode = "numeric", length = length(deltas))
tr_vss <- vector(mode = "numeric", length = length(deltas))

for (i in 1:length(deltas)) {
  
  sim <- gsd_simulations(upper_bounds = tri_bounds$upper_bounds,
                         lower_bounds = tri_bounds$lower_bounds,
                         alt_hypothesis = deltas[i],
                         n_patients = c(20.43845 * 1:3))
  
  tr_power[i] <- sim$power
  tr_ess[i] <- sim$expected_sample_size
  tr_vss[i] <- sim$var_sample_size
  
}
```

### Plot the bounds

```{r}
ggplot() +
  geom_line(mapping = aes(x = 1:3, y = pocock_bounds$upper_bounds, color = "Pocock"),
            linetype = 2) +
  geom_line(mapping = aes(x = 1:3, y = pocock_bounds$lower_bounds, color = "Pocock"),
            linetype = 2) +
  geom_line(mapping = aes(x = 1:3, y = of_bounds$upper_bounds, color = "O'Brien-Fleming")) +
  geom_line(mapping = aes(x = 1:3, y = of_bounds$lower_bounds, color = "O'Brien-Fleming")) +
  geom_line(mapping = aes(x = 1:3, y = tri_bounds$upper_bounds, color = "Triangular")) +
  geom_line(mapping = aes(x = 1:3, y = tri_bounds$lower_bounds, color = "Triangular")) +
  scale_color_manual(name = "Boundary types",
                   breaks = c("Pocock", "O'Brien-Fleming", "Triangular"),
                   values = c("Pocock" = "red", 
                              "O'Brien-Fleming" = "blue", 
                              "Triangular" = "purple")) +
  labs(x = "Analysis Number", y = "Z score", 
       title = "Boundary values for different equations")
```


### ESS

```{r}
ggplot() + 
  geom_line(mapping = aes(x = deltas, y = pk_ess, color = "Pocock")) +
  geom_line(mapping = aes(x = deltas, y = of_ess, color = "O'Brien-Fleming")) +
  geom_line(mapping = aes(x = deltas, y = tr_ess, color = "Triangular")) +
  scale_color_manual(name = "Boundary types",
                     breaks = c("Pocock", "O'Brien-Fleming", "Triangular"),
                     values = c("Pocock" = "red", 
                                "O'Brien-Fleming" = "blue", 
                                "Triangular" = "purple")) +
  labs(x = "True \u03B4", y = "Expected sample size", 
       title = "Expected sample size over range of true \u03B4 values")
```


### VSS

```{r}
ggplot() + 
  geom_line(mapping = aes(x = deltas, y = sqrt(pk_vss), color = "Pocock")) +
  geom_line(mapping = aes(x = deltas, y = sqrt(of_vss), color = "O'Brien-Fleming")) +
  geom_line(mapping = aes(x = deltas, y = sqrt(tr_vss), color = "Triangular")) +
  scale_color_manual(name = "Boundary types",
                     breaks = c("Pocock", "O'Brien-Fleming", "Triangular"),
                     values = c("Pocock" = "red", 
                                "O'Brien-Fleming" = "blue", 
                                "Triangular" = "purple")) +
  labs(x = "True \u03B4", y = "Standard deviation of sample size", 
       title = "Standard deviation of sample size over range of true \u03B4 values")
```


### Power

```{r}
ggplot() +
  geom_line(mapping = aes(x = deltas, y = pk_power, color = "Pocock")) + 
  geom_line(mapping = aes(x = deltas, y = of_power, color = "O'Brien-Fleming")) + 
  geom_line(mapping = aes(x = deltas, y = tr_power, color = "Triangular")) +
  geom_hline(aes(yintercept = 0.8)) +
  scale_color_manual(name = "Boundary types",
                     breaks = c("Pocock", "O'Brien-Fleming", "Triangular"),
                     values = c("Pocock" = "red",
                                "O'Brien-Fleming" = "blue",
                                "Triangular" = "purple")) +
  labs(x = "Alternative hypothesis = \u03B4", 
       y = "Power", 
       title = "Power for different boundaries")
```



# New triangular bounds

Current function:
```
function(n_analyses = 3,
         alpha = 0.05,
         delta = 0.5) {

  I_L_term1 <- (4 * (0.583^2)) / n_analyses
  I_L_term2 <- 8 * log(1/(2*alpha))
  I_L_term3 <- (2 * 0.583) / sqrt(n_analyses)

  I_L <- (sqrt(I_L_term1 + I_L_term2) - I_L_term3)^2 * (1 / delta)^2

  bounds_term1 <- (2/delta) * log(1/(2*alpha))
  bounds_term2 <- 0.583 * sqrt(I_L / n_analyses)

  analysis_fracs <- (1:n_analyses / n_analyses)

  I_L_fracs <- I_L * analysis_fracs

  e_l <- (bounds_term1 - bounds_term2 + ((0.25*delta) * analysis_fracs * I_L )) / sqrt(I_L_fracs)

  f_l <- (-bounds_term1 + bounds_term2 + ((0.75*delta) * analysis_fracs * I_L )) / sqrt(I_L_fracs)

  return(list(upper_bounds = e_l, lower_bounds = f_l, info = I_L_fracs))

}
```

The equations are:

$$
I_L = \left[ \left\{ \frac{4(0.583)^2}{L} + 8\log\left(\frac{1}{2\alpha}\right)  \right\}^{\frac{1}{2}} - \frac{2(0.583)}{L^{\frac{1}{2}}} \right]^2 \left(\frac{1}{\tilde{\delta}}\right)^2
$$
$$
\tilde{\delta} = \frac{2z_{1-\alpha}\delta}{z_{1-\alpha}+z_{1-\beta}}
$$

and

$$
e_l = \left\{ \frac{2}{\tilde{\delta}}\log\left(\frac{1}{2\alpha}\right) - 0.583\left(\frac{I_L}{L}\right)^{\frac{1}{2}} + \frac{\tilde{\delta}}{4}\frac{l}{L}I_L \right\} \frac{1}{I_l^{\frac{1}{2}}}
$$
$$
f_l = \left\{ -\frac{2}{\tilde{\delta}}\log\left(\frac{1}{2\alpha}\right) + 0.583\left(\frac{I_L}{L}\right)^{\frac{1}{2}} + \frac{3\tilde{\delta}}{4}\frac{l}{L}I_L \right\} \frac{1}{I_l^{\frac{1}{2}}}
$$

Two corrections are made above compared to the equations in **Group sequential clinical trial designs for normally distributed outcome variables**, The Stata Journal (2018), Grayling et al. First, in the equation for $I_L$, $\frac{1}{\tilde{\delta}}$ is squared. Second, as this is a one-sided test, the calculation for $\tilde{\delta}$ utilizes $\alpha$ rather that $\alpha/2$.

$e_l$ are the upper bounds, $f_l$ are the lower bounds, $\tilde{\delta}$ is the variable alternative hypothesis depending on type I ($\alpha$) and type II error ($\beta$), $L$ is the total number of analysis, $l$ is current analysis, and $I_L$ is the information over the whole of the trial.

## Delta tilde

```{r}
delta_tilde <- function(beta){
  (2 * qnorm(0.05) * 0.5) / (qnorm(0.05) + qnorm(beta))
}
```


```{r}
beta <- seq(from = 0, to = 0.9, by = 0.05)
plot(x = beta, y = delta_tilde(beta))
```

## Write new function

New function ignoring different sample size considerations in $I_l$:

```{r}
calc_bounds_triangular_new <- function(n_analyses = 3,
                                       alpha = 0.05,
                                       power = 0.8,
                                       delta = 0.5,
                                       n_patients = c(20, 40, 60)) {
  
  beta <- 1-power
  
  delta_tilde <- (2 * qnorm(alpha) * delta) / (qnorm(alpha) + qnorm(beta))
  
  I_L_term1 <- (4 * (0.583^2)) / n_analyses
  I_L_term2 <- 8 * log(1/(2*alpha))
  I_L_term3 <- (2 * 0.583) / sqrt(n_analyses)
  
  # replace delta with delta_tilde
  I_L <- (sqrt(I_L_term1 + I_L_term2) - I_L_term3)^2 * (1 / delta_tilde)^2
  
  # replace delta with delta_tilde
  bounds_term1 <- (2/delta_tilde) * log(1/(2*alpha))
  
  # unchanged
  bounds_term2 <- 0.583 * sqrt(I_L / n_analyses)
  
  analysis_fracs <- (1:n_analyses / n_analyses)
  I_L_fracs <- I_L * analysis_fracs
  
  # replace delta with delta_tilde
  e_l <- (bounds_term1 - bounds_term2 + ((0.25*delta_tilde) * analysis_fracs * I_L )) / sqrt(I_L_fracs)
  
  # replace delta with delta_tilde
  f_l <- (-bounds_term1 + bounds_term2 + ((0.75*delta_tilde) * analysis_fracs * I_L )) / sqrt(I_L_fracs)
  
  # return delta_tilde as well
  return(list(upper_bounds = e_l, 
              lower_bounds = f_l, 
              delta_tilde = delta_tilde,
              info = I_L_fracs))
  
  
}
```


```{r}
calc_bounds_triangular_new(power = 0.8)
```


```{r}
calc_bounds_triangular()
```

```{r}
tri_new <- calc_bounds_triangular_new(power = 0.8)
gsd_simulations(upper_bounds = tri_new$upper_bounds,
                lower_bounds = tri_new$lower_bounds,
                alt_hypothesis = tri_new$delta_tilde)
```


New function with different sample size considerations in $I_l$:

```{r}
calc_bounds_triangular_new_diff <- function(n_analyses = 3,
                                       alpha = 0.05,
                                       power = 0.8,
                                       delta = 0.5,
                                       n_patients = c(20, 40, 60)) {
  
  beta <- 1-power
  
  delta_tilde <- (2 * qnorm(alpha) * delta) / (qnorm(alpha) + qnorm(beta))
  
  I_L_term1 <- (4 * (0.583^2)) / n_analyses
  I_L_term2 <- 8 * log(1/(2*alpha))
  I_L_term3 <- (2 * 0.583) / sqrt(n_analyses)
  
  # replace delta with delta_tilde
  I_L <- (sqrt(I_L_term1 + I_L_term2) - I_L_term3)^2 * (1 / delta_tilde)^2
  
  # replace delta with delta_tilde
  bounds_term1 <- (2/delta_tilde) * log(1/(2*alpha))
  
  # unchanged
  bounds_term2 <- 0.583 * sqrt(I_L / n_analyses)
  
  analysis_fracs <- (1:n_analyses / n_analyses)
  I_L_fracs <- I_L * analysis_fracs
  
  # replace delta with delta_tilde
  e_l <- (bounds_term1 - bounds_term2 + ((0.25*delta_tilde) * analysis_fracs * I_L )) / sqrt(n_patients)
  
  # replace delta with delta_tilde
  f_l <- (-bounds_term1 + bounds_term2 + ((0.75*delta_tilde) * analysis_fracs * I_L )) / sqrt(n_patients)
  
  # return delta_tilde as well
  return(list(upper_bounds = e_l, 
              lower_bounds = f_l, 
              delta_tilde = delta_tilde,
              info = I_L_fracs))
  
  
}
```


```{r}
calc_bounds_triangular_new_diff(power = 0.9)
```

Fix the alternative hypothesis:

```{r}
tri_new_diff <- calc_bounds_triangular_new_diff(power = 0.4)
gsd_simulations(upper_bounds = tri_new_diff$upper_bounds,
                lower_bounds = tri_new_diff$lower_bounds,
                alt_hypothesis = 0.5)
```


Alter the alternative hypothesis:

```{r}
tri_new_diff <- calc_bounds_triangular_new_diff(power = 0.4)
gsd_simulations(upper_bounds = tri_new_diff$upper_bounds,
                lower_bounds = tri_new_diff$lower_bounds,
                alt_hypothesis = tri_new_diff$delta_tilde)
```

